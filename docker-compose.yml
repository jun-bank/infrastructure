services:
  # ========================================
  # 1단계: 기본 인프라 (DB, Tracing)
  # ========================================
  postgres:
    extends:
      file: ./postgres/docker-compose.yml
      service: postgres

  zipkin:
    extends:
      file: ./tracing/docker-compose.yml
      service: zipkin

  # ========================================
  # 2단계: Kafka Cluster (KRaft 3대)
  # ========================================
  kafka-1:
    extends:
      file: ./kafka/docker-compose.yml
      service: kafka-1

  kafka-2:
    extends:
      file: ./kafka/docker-compose.yml
      service: kafka-2

  kafka-3:
    extends:
      file: ./kafka/docker-compose.yml
      service: kafka-3

  kafka-ui:
    extends:
      file: ./kafka/docker-compose.yml
      service: kafka-ui

  # ========================================
  # 3단계: Eureka Servers (이중화)
  # ========================================
  eureka-server-1:
    extends:
      file: ./eureka-server/docker-compose.yml
      service: eureka-server-1
    depends_on:
      zipkin:
        condition: service_healthy

  eureka-server-2:
    extends:
      file: ./eureka-server/docker-compose.yml
      service: eureka-server-2
    depends_on:
      zipkin:
        condition: service_healthy

  # ========================================
  # 4단계: Config Server (Eureka 의존)
  # ========================================
  config-server:
    extends:
      file: ./config-server/docker-compose.yml
      service: config-server
    depends_on:
      eureka-server-1:
        condition: service_healthy
      eureka-server-2:
        condition: service_healthy

  # ========================================
  # 5단계: Gateway Servers (이중화)
  # ========================================
  gateway-server-1:
    extends:
      file: ./gateway-server/docker-compose.yml
      service: gateway-server-1
    depends_on:
      config-server:
        condition: service_healthy
      kafka-1:
        condition: service_healthy

  gateway-server-2:
    extends:
      file: ./gateway-server/docker-compose.yml
      service: gateway-server-2
    depends_on:
      config-server:
        condition: service_healthy
      kafka-1:
        condition: service_healthy

  # ========================================
  # 6단계: ELK Stack
  # ========================================
  elasticsearch:
    extends:
      file: ./elk/docker-compose.yml
      service: elasticsearch

  logstash:
    extends:
      file: ./elk/docker-compose.yml
      service: logstash

  kibana:
    extends:
      file: ./elk/docker-compose.yml
      service: kibana

  # ========================================
  # 7단계: Monitoring
  # ========================================
  prometheus:
    extends:
      file: ./monitoring/docker-compose.yml
      service: prometheus

  grafana:
    extends:
      file: ./monitoring/docker-compose.yml
      service: grafana

  alertmanager:
    extends:
      file: ./monitoring/docker-compose.yml
      service: alertmanager

  # ========================================
  # 8단계: Nginx (Gateway 의존)
  # ========================================
  nginx:
    extends:
      file: ./nginx/docker-compose.yml
      service: nginx
    depends_on:
      gateway-server-1:
        condition: service_healthy
      gateway-server-2:
        condition: service_healthy

  # ========================================
  # 9단계: Business Services
  # ========================================
#  user-service:
#    extends:
#      file: ./services/user-service/docker-compose.yml
#      service: user-service
#    depends_on:
#      postgres:
#        condition: service_healthy
#      config-server:
#        condition: service_healthy
#      kafka-1:
#        condition: service_healthy
#
#  auth-server:
#    extends:
#      file: ./services/auth-server/docker-compose.yml
#      service: auth-server
#    depends_on:
#      postgres:
#        condition: service_healthy
#      config-server:
#        condition: service_healthy
#      kafka-1:
#        condition: service_healthy
#
#  account-service:
#    extends:
#      file: ./services/account-service/docker-compose.yml
#      service: account-service
#    depends_on:
#      postgres:
#        condition: service_healthy
#      config-server:
#        condition: service_healthy
#      kafka-1:
#        condition: service_healthy
#
#  transaction-service:
#    extends:
#      file: ./services/transaction-service/docker-compose.yml
#      service: transaction-service
#    depends_on:
#      postgres:
#        condition: service_healthy
#      config-server:
#        condition: service_healthy
#      kafka-1:
#        condition: service_healthy
#
#  transfer-service:
#    extends:
#      file: ./services/transfer-service/docker-compose.yml
#      service: transfer-service
#    depends_on:
#      postgres:
#        condition: service_healthy
#      config-server:
#        condition: service_healthy
#      kafka-1:
#        condition: service_healthy
#
#  card-service:
#    extends:
#      file: ./services/card-service/docker-compose.yml
#      service: card-service
#    depends_on:
#      postgres:
#        condition: service_healthy
#      config-server:
#        condition: service_healthy
#      kafka-1:
#        condition: service_healthy
#
#  ledger-service:
#    extends:
#      file: ./services/ledger-service/docker-compose.yml
#      service: ledger-service
#    depends_on:
#      postgres:
#        condition: service_healthy
#      config-server:
#        condition: service_healthy
#      kafka-1:
#        condition: service_healthy

networks:
  jun-bank-network:
    name: jun-bank-network
    driver: bridge